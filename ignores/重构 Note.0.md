*HOW?*

### 两顶帽子

Kent Beck有一个“两顶帽子”的比喻。使用重构技术开发软件时，你把自己的时间分配给两种截然不同的行为：添加新功能，以及重构。添加新功能时，你不应该修改既有代码。通过测试(并让测试正常运行)，你可以衡量自己的工作进度。重构时你不能再添加功能，只管改进程序结构。此时你不应该添加任何测试（除非发现有先前遗漏的东西），只在绝对必要（用以处理接口变化）时才修改测试。



### 为何重构

**改进软件设计**

> 如果没有重构，程序的设计会逐渐腐败变质。当人们只为短期目的，或是在完全理解整体设计之前，就贸然修改代码，程序将逐渐失去自己的结构，程序员愈来愈难通过阅读源码而理解原来的设计。 …… 经常性的重构可以帮助程序维持自己该有的样子

> 完成同样的一件事，设计不良的程序往往需要更多代码(没法坚持Don't Repeat Me原则)。因此改进的一个重要方向就是消除重复代码。如果消除重复代码，你就可以确定所有的事物和行为在代码中只表述一次，这正式优秀设计的根本。



**重构使软件更容易理解**

>  除了计算机，你的代码还有其他读者: 几个月后的另一位程序员尝试读懂你的代码并做一些修改。我们很容易忘记这位读者，但他才是最重要的。如果他花一周时间来修改某段代码，这真的要命。
>
> 问题在于，当你努力让程序运作的时候，不会想到未来出现的那个开发者。是的，我们应该改变一下开发节奏，对代码进行适当的修改，让代码变得更易理解。重构可以帮助我们让代码更易读。
>
> 一开始我所做的重构都像这样停留在细枝末节上。随着代码渐趋简洁，我发现自己可以看到一些以前看不到的设计层面的东西。如果不对代码做这些修改，也许我永远看不见它们，因为我的充满才智不足以在脑子里把这一切都想象出来。Ralph Johnson把这种“早期重构”描述为“擦掉窗户上的污垢，是你看得更远”。



**重构帮助找到bug**

> 重构迫使自己理解程序结构，做出假设，自然而然得就把bug找出来了。



**重构提高编程速度**

> 良好的设计是快速开发的根本 —— 事实上，拥有良好的设计才可能做到快速开发。如果没有良好的设计，或许某一段时间内你的进展迅速，但恶劣的设计很快就让你的速度慢下来。你会把时间花在调试上面，无法添加新功能。



### 何时重构:三次法则

> 事不过三，三则重构



### 简洁层和重构

> “计算机科学是这样一门科学；它相信所有问题都可以通过增加一个间接层来解决。”
>
> —— Kent Beck

在重构中，有很多手段就是通过增加或移除一个中间层实现的，过多细粒度的中间层，或者是过度耦合的代码都是需要重构的对象。

### 局限

1. 数据库
2. 修改接口
   1. 保留旧接口调用新接口，并善用@deprecated
3. 难以通过重构手段完成的设计改动
4. 何时不该重构
   1. 实在没法收拾了，还是重写来得效率更高吧
   2. DeadLine临近，不管怎么样得先把项目压力顶过去

### 重构与性能

IMPORTANT:

过早得对程序进行优化和管控只出现与极少数迫切需要实时性的程序上，而剩下的大部分程序这样做的收益是微乎其微的。

主观的臆测都是无用的，只有对程序进行实时得统计与分析，对程序的性能有了一个清晰的认识之后。集中于性能热点，采用持续关注法的手段去不停优化这些热点，才是最实在的方法。每走一步都进行测试，再次度量，如果没能提高性能，就应该撤销此次修改。如此循环，直到获得满意的性能。